<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Invalid double崩溃分析 | SamyChen</title>
  <meta name="author" content="SamyChen">
  
  <meta name="description" content="学习总结 思考感悟">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Invalid double崩溃分析"/>
  <meta property="og:site_name" content="SamyChen"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link rel="alternate" href="/atom.xml" title="SamyChen" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!-- wumiiVerification -->
  <meta name="wumiiVerification" content="fb50a101-84fe-4ca2-91a7-ae8cf792978b" />
  <meta name="wumiiVerification" content="d73b5866-c390-4156-a4dd-51b526b5335e" />
  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Font-Awesome -->
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

</head>

<body>
  <header id="header"><div class= "header-content inner">
	<div class = "alignleft col-one">
		
			<div class='avatar'>
				<img src = "/img/default/head.jpg">
              </div>
		
		<div class="header-div">
		    <h1><a href="/">SamyChen</a></h1>
		    <h2><a href="/">SamyChen的博客</a></h2>
		</div>
	</div>
	<div class = "alignright col-two">
		
            <div class="ad">
			<img src = "/img/default/head.jpg">
            </div>
		
	</div>
	<div class="clearfix"></div>
</div>

<div class= "header-nav">
	<div class='header-nav-content inner'>
		<div id="main-nav" class="alignleft">
		    		
		    		  <a href="/"><i class="fa fa-home"></i>首页</a>
		    		
		    		  <a href="/archives"><i class="fa fa-archive"></i>归档</a>
		    		
		    		  <a href="/hexo"><i class="fa fa-book"></i>电子书</a>
		    		
		    		  <a href="/about"><i class="fa fa-user"></i>关于我</a>
		    		
		</div>
		<div id="sub-nav" class="alignright">
		    
		      <a href="/atom.xml"><i class="fa fa-rss"></i>订阅</a>
		    
		      <a href="/customization"><i class="fa fa-question-circle"></i>留言</a>
		    
		</div>
	</div>
	<div class="clearfix"></div>
</div>
</header>
  
    <div id="content" class="inner">
      <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2016-04-12T06:06:15.000Z"><a href="/2016/04/12/Invalid-double崩溃分析/">2016-04-12</a></time>
        
  
    <h1 class="title">Invalid double崩溃分析</h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        
    </div>

        <p>第一次遇到</p>
<p>java.lang.NumberFormatException: Invalid double: “0,3”<br>这样包含逗号的浮点数异常，第一感觉就是服务器给的数据错误，但前段时间复现了这个异常，才发现是代码不规范导致了这样的异常： 崩溃的详细log如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">E/AndroidRuntime: FATAL EXCEPTION: mainProcess: com.frank.lollipopdemo, PID: </div><div class="line">10898java.lang.RuntimeException: Unable to start activity </div><div class="line">ComponentInfo&#123;com.frank.lollipopdemo/com.frank.lollipopdemo.MainActivity&#125;: </div><div class="line">java.lang.NumberFormatException: Invalid double: &quot;0,3&quot; at </div><div class="line">android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2325) at </div><div class="line">android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2387) at </div><div class="line">android.app.ActivityThread.access$800(ActivityThread.java:151) at </div><div class="line">android.app.ActivityThread$H.handleMessage(ActivityThread.java:1303) at </div><div class="line">android.os.Handler.dispatchMessage(Handler.java:102) at android.os.Looper.loop(Looper.java:135) at </div><div class="line">android.app.ActivityThread.main(ActivityThread.java:5254) at java.lang.reflect.Method.invoke(Native </div><div class="line">Method) at java.lang.reflect.Method.invoke(Method.java:372) at </div><div class="line">com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:903) at </div><div class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:698) Caused by: </div><div class="line">java.lang.NumberFormatException: Invalid double: &quot;0,3&quot; at </div><div class="line">java.lang.StringToReal.invalidReal(StringToReal.java:63) at </div><div class="line">java.lang.StringToReal.initialParse(StringToReal.java:164) at </div><div class="line">java.lang.StringToReal.parseDouble(StringToReal.java:282) at </div><div class="line">java.lang.Double.parseDouble(Double.java:301) at </div><div class="line">com.frank.lollipopdemo.MainActivity.onCreate(MainActivity.java:43) at </div><div class="line">android.app.Activity.performCreate(Activity.java:5990) at </div><div class="line">android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1106) at </div><div class="line">android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2278) at </div><div class="line">android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2387) at </div><div class="line">android.app.ActivityThread.access$800(ActivityThread.java:151) at </div><div class="line">android.app.ActivityThread$H.handleMessage(ActivityThread.java:1303) at </div><div class="line">android.os.Handler.dispatchMessage(Handler.java:102) at android.os.Looper.loop(Looper.java:135) at </div><div class="line">android.app.ActivityThread.main(ActivityThread.java:5254) at java.lang.reflect.Method.invoke(Native </div><div class="line">Method) at java.lang.reflect.Method.invoke(Method.java:372) at </div><div class="line">com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:903) at</div><div class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:698)</div></pre></td></tr></table></figure></p>
<p>而出错的代码是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        tv_title = (TextView) findViewById(R.id.tv_title);</div><div class="line">        tv_content = (TextView) findViewById(R.id.tv_content);</div><div class="line">        String jsonVal = &quot;0.31415926&quot;;</div><div class="line">        String title = remain1Places(jsonVal);// -&gt; 0.3</div><div class="line">        tv_title.setText(title);</div><div class="line">        tv_content.setText(getPercent(Double.parseDouble(title)));// -&gt; ##.##%</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static String remain1Places(String string) &#123;</div><div class="line">        if (TextUtils.isEmpty(string)) &#123;</div><div class="line">            return &quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        return String.format(&quot;%.1f&quot;, Double.parseDouble(string));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static String getPercent(double value) &#123;</div><div class="line">        NumberFormat numberFormat = NumberFormat.getPercentInstance();</div><div class="line">        numberFormat.setMinimumFractionDigits(1);</div><div class="line">        numberFormat.setMaximumFractionDigits(2);</div><div class="line">        return numberFormat.format(value);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>想把浮点数”0.31415926”保留一位小数，就使用了String.format()<br>方法完成，而且完全不顾编译器对我们的建议： <img src="http://upload-images.jianshu.io/upload_images/4398977-6b4a754e0cd9d8cb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述">之后，我们想把保留了一位小数后的浮点数”0.3”转成百分比的形式”30.0%”，当然先转成double，然后利用NumberFormat<br>格式化成百分比。 看似没有问题，但是当我们把系统语言换成法语(France)之后，程序直接Crash，而且当我们只显示remain1Places()<br>后的title时，发现”0.31415926”变成了”0,3”，而不是”0.3”，这就直接导致了Double.parseDouble(“0,3”)抛出一个数据格式异常。 那为什么String.format()<br>会将小数点的”句点(.)“换成了”逗号(,)“呢？<br>摘自<a href="https://en.wikipedia.org/wiki/Decimal_mark" target="_blank" rel="external">维基百科</a>： A decimal mark is a symbol used to separate the integer part from the fractional part of a number written in decimal form. Different countries officially designate different symbols for the decimal mark. The choice of symbol for the decimal mark also affects the choice of symbol for the thousands separator used in digit grouping, so the latter is also treated in this article. <img src="http://upload-images.jianshu.io/upload_images/4398977-562e843356d6da5e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<p>可以看到，有很多地区都是用<strong>逗号(,)</strong>作为<strong>小数点</strong>的，如19,90€表示19.9欧元；但计算机程序中的浮点数必须用<strong>句点(.)</strong>作为小数点，如double price = 19.90;<br>表示浮点数19.9。所以在使用double的包装类Double<br>的parseDouble(String)<br>或valueOf(String)<br>方法将字符串表示的double值转成double时，字符串所表示的double值必须是用<strong>句点(.)</strong>分隔的浮点数，也就是计算机的浮点数表示形式。<br>Double.valueOf(String)<br>方法仅仅调用了Double.parseDouble(String)<br>并返回Double<br>对象。 Double.parseDouble(String)<br>方法返回原语类型的double<br>变量。</p>
<p>因此，我们就可以断定这是一个本地化（Locale）的问题了。现在再来看一下编译器(lint)给我们String.format()<br>方法的建议：<br>Implicitly using the default locale is a common source of bugs: Use String.format(Locale, …) instead. 隐式地使用默认的区域设置是常见Bug源，请使用String.format(Locale, …)等方法替换它。</p>
<p>也就是说，String.format(String format, Object… args)<br>会调用format(Locale.getDefault(), format, args)<br>使用<strong>用户默认的区域设置</strong>返回格式化好且本地化好的字符串，因用户设置的不同而返回不同的字符串，进而出现Bug。如果你只是想格式化字符串而不是人为干预，应该用</p>
<p><code>String.format(Locale locale, String format, Object... args)</code><br>方法，Locale参数用Locale.US<br>就可以了。<br>因此，我们应该重视本地化问题：<br>将字符串所有字符转为大/小写的方法String.toLowerCase()<br>/String.toUpperCase()<br>并不一定能将字符真正的大/小写（如区域设置为土耳其时，i大写后还是i），因此应该指定要使用的区域设置String.toLowerCase(Locale locale)<br>/String.toUpperCase(Locale locale)<br>。<br>格式化字符串的方法String.format(String format, Object… args)<br>应该指定区域设置，以避免区域设置变化导致的Bug。<br><strong>千万不要将数字format()<br>成字符串后再将该字符串转回原语类型</strong>，因为format()<br>后的字符串可能不是合法的原语类型的数字了。即永远不要出现类似这样</p>
<p>Double.parseDouble(new DecimalFormat(“#.##”).format(doubleValue))<br>的代码。<br>建议使用NumberFormat<br>，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public static String remain1Places(String str) &#123;</div><div class="line">    NumberFormat numberFormat = NumberFormat.getInstance(Locale.getDefault());</div><div class="line">    numberFormat.setMinimumFractionDigits(1);</div><div class="line">    numberFormat.setMaximumFractionDigits(1);</div><div class="line">    return numberFormat.format(Double.parseDouble(str));</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static String getPercent(String str) &#123;</div><div class="line">    NumberFormat numberFormat = NumberFormat.getPercentInstance(Locale.getDefault());</div><div class="line">    numberFormat.setMinimumFractionDigits(1);</div><div class="line">    numberFormat.setMaximumFractionDigits(2);</div><div class="line">    return numberFormat.format(Double.parseDouble(str));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/Android/">Android</a>
  </div>

        
  <div class="tags">
    <a href="/tags/安卓/">安卓</a>
  </div>

        <div class = "counter">
  <span id="busuanzi_container_page_pv" style="display:none">
      总访问&nbsp<span id="busuanzi_value_page_pv"></span>&nbsp次
  </span>
</div>
        
  <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a title="分享到QQ空间" href="#" class="bds_qzone" data-cmd="qzone"></a><a title="分享到新浪微博" href="#" class="bds_tsina" data-cmd="tsina"></a><a title="分享到腾讯微博" href="#" class="bds_tqq" data-cmd="tqq"></a><a title="分享到人人网" href="#" class="bds_renren" data-cmd="renren"></a><a title="分享到微信" href="#" class="bds_weixin" data-cmd="weixin"></a></div>
  <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>

      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>

  
<section id = "relate">
	
                <div id="null"></div>
	
</section>


  
    <section id="comment">
    <!--   <h1 class="title">留言</h1> -->
    
    
        <!-- 多说评论框 start -->
        <div class="ds-thread" data-thread-key="2016/04/12/Invalid-double崩溃分析/" data-title="Invalid double崩溃分析" data-url="http://samychen.com/2016/04/12/Invalid-double崩溃分析/"></div>
        <!-- 多说评论框 end -->
        <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
        <script type="text/javascript">
        var duoshuoQuery = {short_name:"samychen"};
          (function() {
            var ds = document.createElement('script');
            ds.type = 'text/javascript';ds.async = true;
            ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
            ds.charset = 'UTF-8';
            (document.getElementsByTagName('head')[0] 
             || document.getElementsByTagName('body')[0]).appendChild(ds);
          })();
          </script>
        <!-- 多说公共JS代码 end -->

      
    </section>




</div></div>
      <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title" id="categories">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SSL/">SSL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul> 
</div>
 


  <div class="widget tag">
  <h3 class="title">微信公众账号</h3>
    <ul class="entry">
      <img src="/img/default/wx.png" alt="欢迎关注，该账号供个人学习使用，偶尔做一些开发尝试，更新频率较低。" style= "width: 100%">
    </ul>
</div>

  <div class="widget tag">
  <h3 class="title">日历云</h3>
  <div id="calendar"></div>
</div>


  
<div class="widget">
  <h3 class="title">最新评论</h3>
  	<!-- 多说最新评论 start -->
	<div class="ds-recent-comments ds-recent-user" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="70"></div>
	<!-- 多说最新评论 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"samychen"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
	<!-- 多说公共JS代码 end -->
</div>



  


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/SSL，Https/" style="font-size: 14px;">SSL，Https</a> <a href="/tags/SSL，Https，安卓/" style="font-size: 10px;">SSL，Https，安卓</a> <a href="/tags/单例模式/" style="font-size: 12px;">单例模式</a> <a href="/tags/安卓/" style="font-size: 18px;">安卓</a> <a href="/tags/安卓，Java/" style="font-size: 16px;">安卓，Java</a> <a href="/tags/工厂模式/" style="font-size: 10px;">工厂模式</a> <a href="/tags/生产者消费者模式/" style="font-size: 12px;">生产者消费者模式</a> <a href="/tags/装饰者模式/" style="font-size: 12px;">装饰者模式</a>
  </div>
</div>


  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">公元 2017 年</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">公元 2016 年</a><span class="archive-list-count">18</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/">公元 2015 年</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/">公元 2014 年</a><span class="archive-list-count">10</span></li></ul>
  </div>

</aside>
      <div class="clearfix"></div>
    </div>
  
  <footer id="footer"><div class="footer-content inner">
  <div class="alignleft">
  
    &copy; 2017 SamyChen
    
  </div>
  <div class="alignright">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme
    <a href="https://github.com/pengloo53/Hexo-theme-light_cn">light_cn</a>
  </div>
  
  <div class="visit">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </div>
  
  <div class="clearfix"></div>
</div></footer>
  <script src="http://libs.baidu.com/jquery/2.1.1/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<!-- calendar widget -->

  <script src="/js/calendar.js"></script>
  <script src="/js/languages.js"></script>
  <script type="text/javascript">
    $(function() {
    
      $('#calendar').aCalendar('zh-CN',{single:undefined, root:'calendar'});
    
    });
  </script>


<!-- 『不蒜子』计数服务 -->
<script async src="http://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- wumii关联推荐 -->
<script type="text/javascript" src="http://widget.wumii.cn/ext/relatedItemsWidget"></script>

<!-- 百度推荐 -->

	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?9acf0cedd48dc53be256ede5a98c2aaa";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<!-- 返回顶部 -->
<div id="toTop">
	<a href="#">▲</a>
	<a href="#footer">▼</a>
</div>

<!-- 站内搜索-Swiftype -->
<!-- <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','sC-iNFrvTTNtiXEVNwo1','2.0.0');
</script> -->

<!-- fancybox -->

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
