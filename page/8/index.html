<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 8 页 | SamyChen</title>
  <meta name="author" content="SamyChen">
  
  <meta name="description" content="学习总结 思考感悟">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="SamyChen"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link rel="alternate" href="/atom.xml" title="SamyChen" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <!-- wumiiVerification -->
  <meta name="wumiiVerification" content="fb50a101-84fe-4ca2-91a7-ae8cf792978b" />
  <meta name="wumiiVerification" content="d73b5866-c390-4156-a4dd-51b526b5335e" />
  <!-- favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Font-Awesome -->
  <link rel="stylesheet" href="/font-awesome/css/font-awesome.min.css">

</head>

<body>
  <header id="header"><div class= "header-content inner">
	<div class = "alignleft col-one">
		
			<div class='avatar'>
				<img src = "/img/default/head.jpg">
              </div>
		
		<div class="header-div">
		    <h1><a href="/">SamyChen</a></h1>
		    <h2><a href="/">SamyChen的博客</a></h2>
		</div>
	</div>
	<div class = "alignright col-two">
		
            <div class="ad">
			<img src = "/img/default/head.jpg">
            </div>
		
	</div>
	<div class="clearfix"></div>
</div>

<div class= "header-nav">
	<div class='header-nav-content inner'>
		<div id="main-nav" class="alignleft">
		    		
		    		  <a href="/"><i class="fa fa-home"></i>首页</a>
		    		
		    		  <a href="/archives"><i class="fa fa-archive"></i>归档</a>
		    		
		    		  <a href=""><i class="fa fa-book"></i>电子书</a>
		    		
		    		  <a href="/about"><i class="fa fa-user"></i>关于我</a>
		    		
		</div>
		<div id="sub-nav" class="alignright">
		    
		      <a href="https://github.com/samychen"><i class="fa fa-"></i>github</a>
		    
		      <a href="https://plus.google.com/u/0/103829504368344048794"><i class="fa fa-"></i>google</a>
		    
		</div>
	</div>
	<div class="clearfix"></div>
</div>
</header>
  
    <div id="content" class="inner">
      <div id="main-col" class="alignleft"><div id="wrapper">
    <article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2016-04-23T12:48:41.000Z"><a href="/2016/04/23/RXAndroid/">2016-04-23</a></time>
        
  
    <h1 class="title"><a href="/2016/04/23/RXAndroid/">RXAndroid</a></h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#常见API"><span class="toc-text">常见API</span></a></li></ol>
    </div>

        <p>&emsp;&emsp;RxJava是一个基于可观测序列组成的异步的、基于事件的库。通俗一点说就是RxJava它是一个异步库，这个异步库可以让我们用非常简洁的代码来处理复杂数据流或者事件。</p>
<p>&emsp;&emsp;RxJava中两个最最基础的概念，一个是Observable，还有一个是Observer，其中Observable我们称之为被观察者，Observer称之为观察者，Observable用户发送消息，而Observer用于消费消息，在实际开发中，我们更多的是选择Observer的一个子类Subscriber来消费消息。在消息发送的过程中，Observable可以发送任意数量任意类型的消息（甚至一个将一个触摸事件当作一个消息发出），当Observable所发送的消息被成功处理或者消息出错时，一个流程结束。Observable会用它的每一个Subscriber（观察者）的onNext方法进行消息处理，在消息成功处理后以onComplete()方法结束流程，如果消息在处理的过程中出现了任何异常，则以onError()方法结束流程。比如下面几行代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Observable.OnSubscribe&lt;String&gt;() &#123;  </div><div class="line">            @Override  </div><div class="line">            public void call(Subscriber&lt;? super String&gt; subscriber) &#123;  </div><div class="line">                subscriber.onNext(&quot;哈哈哈哈&quot;);  </div><div class="line">                subscriber.onNext(&quot;lalalala&quot;);  </div><div class="line">                subscriber.onCompleted();  </div><div class="line">            &#125;  </div><div class="line">        &#125;)  </div><div class="line">                .subscribe(new Observer&lt;String&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public void onCompleted() &#123;  </div><div class="line">                        Log.d(&quot;google_lenve_fb&quot;, &quot;onCompleted: onCompleted()&quot;);  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onError(Throwable e) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve_fb&quot;, &quot;onError:onError() &quot;);  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onNext(String s) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve_fb&quot;, &quot;onNext: &quot; + s);  </div><div class="line">                    &#125;  </div><div class="line">                &#125;);</div></pre></td></tr></table></figure></p>
<p>&emsp;&emsp;通过调用Observable的create方法来创建一个消息源，在它的onCall方法调用next方法来发送两条消息，当两条消息发送完成之后，调用onComplete方法表示消息发送完毕！subscribe表示订阅一条消息，在订阅的时候我们可以传入一个Observer对象，也可以传入一个Subscriber对象，这两个对象中的方法都是一样的，在onNext方法中处理消息，当消息处理完成之后会自动的调用onComplete方法，如果消息处理过程中出错，则会调用onError方法</p>
<p>如果我在onNext方法执行一行  1/0 ，onNext方法改成下面的样子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void onNext(String s) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve_fb&quot;, &quot;onNext: &quot; + s);  </div><div class="line">                        int i = 1 / 0;  </div><div class="line">                    &#125;</div></pre></td></tr></table></figure></p>
<p>打印结果如下：<br>onNext: 哈哈哈哈<br>onError:onError()   </p>
<p>当第一条消息打印出来之后，执行1/0时抛异常，直接调用了onError方法，第二条消息将不再处理</p>
<h4 id="常见API"><a href="#常见API" class="headerlink" title="常见API"></a>常见API</h4><ul>
<li>1 from函数<br>Observale中的from函数接受一个数组，这个方法返回一个按数组元素的顺序来发射这些数据的Observale</li>
<li>2  just函数<br>just函数它接受最多10个参数，返回一个按参数顺序发射这些数据的Observable</li>
<li>3 map函数<br>map函数可以对Observable创建的原始数据进行二次加工，然后再被观察者获取<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Observable.from(new String[]&#123;&quot;Observable Test stringOne&quot;,&quot;Observable Test stringTwo&quot;&#125;)  </div><div class="line">                .map(new Func1&lt;String, String&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public String call(String s) &#123;  </div><div class="line">                        return s + &quot;---end&quot;;  </div><div class="line">                    &#125;  </div><div class="line">                &#125;)  </div><div class="line">                .subscribe(new Observer&lt;String&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onNext(String s) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve_fb&quot;, &quot;onNext: &quot; + s);  </div><div class="line">                    &#125;  </div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>打印结果如下：<br>Observable Test stringOne”—end<br>Observable Test stringTwo”—end<br>RxJava的使用都是链式编程，使用map函数时数据来源可以各种各样</p>
<ul>
<li>4 flatMap函数<br>flatMap函数接受一个Observable函数作为输入函数，然后在这个输入的基础上再创建一个新的Observable进行输出，比如下面一段代码：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[java] view plain copy print?Observable.just(&quot;Test stringOne&quot;, &quot;Test stringTwo&quot;)  </div><div class="line">                .flatMap(new Func1&lt;String, Observable&lt;String&gt;&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public Observable&lt;String&gt; call(String s) &#123;  </div><div class="line">                        return Observable.from(new  String[]&#123;s + &quot;endOne&quot;, s + &quot;endTwo&quot;&#125;);  </div><div class="line">                    &#125;  </div><div class="line">                &#125;).subscribe(new Subscriber&lt;String&gt;() &#123;  </div><div class="line">            @Override  </div><div class="line">            public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            @Override  </div><div class="line">            public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            @Override  </div><div class="line">            public void onNext(String s) &#123;  </div><div class="line">                Log.d(&quot;google_lenve_fb&quot;, &quot;onNext: &quot; + s);  </div><div class="line">            &#125;  </div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>打印结果：<br>Test stringOneendOne<br>Test stringOneendTwo<br>Test stringTwoendOne<br>Test stringTwoendTwo</p>
<ul>
<li>5 scan函数<br>scan函数是一个累加器函数，对于Observable发射的每项数据进行累加，并将累加<br>的结果返回，如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">[java] view plain copy print?Observable.just(1, 2, 3, 4, 5, 6, 7, 8, 9, 10)  </div><div class="line">                .scan(new Func2&lt;Integer, Integer, Integer&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public Integer call(Integer integer, Integer integer2) &#123;  </div><div class="line">                        return integer + integer2;  </div><div class="line">                    &#125;  </div><div class="line">                &#125;)  </div><div class="line">                .subscribe(new Observer&lt;Integer&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onNext(Integer integer) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve_fb&quot;, &quot;onNext: &quot; + integer);  </div><div class="line">                    &#125;  </div><div class="line">                &#125;);  </div><div class="line">        Observable.from(new String[]&#123;&quot;明&quot;, &quot;月&quot;, &quot;别&quot;, &quot;枝&quot;, &quot;惊&quot;, &quot;鹊&quot;&#125;)  </div><div class="line">                .scan(new Func2&lt;String, String, String&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public String call(String s, String s2) &#123;  </div><div class="line">                        return s + s2;  </div><div class="line">                    &#125;  </div><div class="line">                &#125;)  </div><div class="line">                .subscribe(new Subscriber&lt;String&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onNext(String s) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve&quot;, &quot;onNext: &quot; + s);  </div><div class="line">                    &#125;  </div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>打印结果如下：<br>D/google_lenve_fb: onNext: 1<br>D/google_lenve_fb: onNext: 3<br>D/google_lenve_fb: onNext: 6<br>D/google_lenve_fb: onNext: 10<br>D/google_lenve_fb: onNext: 15<br>D/google_lenve_fb: onNext: 21<br>D/google_lenve_fb: onNext: 28<br>D/google_lenve_fb: onNext: 36<br>D/google_lenve_fb: onNext: 45<br>D/google_lenve_fb: onNext: 55<br>D/google_lenve: onNext: 明<br>D/google_lenve: onNext: 明月<br>D/google_lenve: onNext: 明月别<br>D/google_lenve: onNext: 明月别枝<br>D/google_lenve: onNext: 明月别枝惊<br>D/google_lenve: onNext: 明月别枝惊鹊  </p>
<ul>
<li><p>6 elementAt函数<br>elementAt函数表示获取数据源中的第N项数据输出</p>
</li>
<li><p>7 merge函数<br>merge函数可以用来合并多个Observable数据源，然后将合并后的数据在一起输出，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[java] view plain copy print?Observable&lt;String&gt; observable1 = Observable.just(&quot;十里楼台倚翠薇&quot;, &quot;百花深处杜鹃啼&quot;);  </div><div class="line">        Observable&lt;String&gt; observable2 = Observable.just(&quot;殷勤自与行人语&quot;,&quot;不似流莺取次飞&quot;);  </div><div class="line">        Observable.merge(observable1, observable2)  </div><div class="line">                .subscribe(new Subscriber&lt;String&gt;() &#123;  </div><div class="line">                    @Override  </div><div class="line">                    public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">                    &#125;  </div><div class="line">  </div><div class="line">                    @Override  </div><div class="line">                    public void onNext(String s) &#123;  </div><div class="line">                        Log.d(&quot;google_lenve&quot;, &quot;onNext: &quot;+s);  </div><div class="line">                    &#125;  </div><div class="line">                &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>打印结果如下：<br>D/google_lenve: onNext: 十里楼台倚翠薇<br>D/google_lenve: onNext: 百花深处杜鹃啼<br>D/google_lenve: onNext: 殷勤自与行人语<br>D/google_lenve: onNext: 不似流莺取次飞  </p>
<ul>
<li>8 zip函数<br>zip函数用来合并多个Observable的数据源，但是与merge不同的是，zip函数中可以对数据源进行二次操作，而不是简单的合并，代码如下：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[java] view plain copy print?Observable&lt;String&gt; observable1 = Observable.just(&quot;十里楼台倚翠薇&quot;, &quot;百花深处杜鹃啼&quot;);  </div><div class="line">        Observable&lt;String&gt; observable2 = Observable.just(&quot;问君能有几多愁&quot;,&quot;恰似一江春水向东流&quot;);  </div><div class="line">        Observable.zip(observable1, observable2, new Func2&lt;String, String, Object&gt;() &#123;  </div><div class="line">            @Override  </div><div class="line">            public Object call(String s, String s2) &#123;  </div><div class="line">                return s+s2;  </div><div class="line">            &#125;  </div><div class="line">        &#125;)  </div><div class="line">        .subscribe(new Subscriber&lt;Object&gt;() &#123;  </div><div class="line">            @Override  </div><div class="line">            public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            @Override  </div><div class="line">            public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">            &#125;  </div><div class="line">  </div><div class="line">            @Override  </div><div class="line">            public void onNext(Object o) &#123;  </div><div class="line">                Log.d(&quot;google_lenve&quot;, &quot;onNext: &quot;+o.toString());  </div><div class="line">            &#125;  </div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>打印结果如下：<br>D/google_lenve: onNext: 十里楼台倚翠薇问君能有几多愁<br>D/google_lenve: onNext: 百花深处杜鹃啼恰似一江春水向东流  </p>
<ul>
<li>9 过滤函数<br>Observable函数中还有其他一些好用的过滤函数<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">private void m7() &#123;  </div><div class="line">    Observable.just(10, 12, 13, 14, 15, 16, 16, 16, 17, 18)  </div><div class="line">        //在数据序列的开头插入一条指定的项1  </div><div class="line">            .startWith(2)  </div><div class="line">            .filter(new Func1&lt;Integer, Boolean&gt;() &#123;  </div><div class="line">                @Override  </div><div class="line">                public Boolean call(Integer integer) &#123;  </div><div class="line">                    return integer &gt; 0;  </div><div class="line">                &#125;  </div><div class="line">            &#125;)  </div><div class="line">        //只发射前N个元素  </div><div class="line">            .take(2)  </div><div class="line">        //只发射最后N个元素  </div><div class="line">            .takeLast(2)  </div><div class="line">        //只发射第一个元素  </div><div class="line">            .first()  </div><div class="line">        //只发射最后一个元素  </div><div class="line">            .last()  </div><div class="line">        //跳过前两个  </div><div class="line">            .skip(2)  </div><div class="line">            //跳过最后两个  </div><div class="line">            .skipLast(2)  </div><div class="line">            //数据过滤，过滤掉重复数据  </div><div class="line">            .distinct()  </div><div class="line">            .subscribe(new Observer&lt;Integer&gt;() &#123;  </div><div class="line">                @Override  </div><div class="line">                public void onCompleted() &#123;  </div><div class="line">  </div><div class="line">                &#125;  </div><div class="line">  </div><div class="line">                @Override  </div><div class="line">                public void onError(Throwable e) &#123;  </div><div class="line">  </div><div class="line">                &#125;  </div><div class="line"> </div><div class="line">                @Override  </div><div class="line">                public void onNext(Integer integer) &#123;  </div><div class="line">                    Log.d(&quot;google_lenve_fb&quot;, &quot;onNext: &quot; + integer);  </div><div class="line">                &#125;  </div><div class="line">            &#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>推荐参考<br><a href="http://wuxiaolong.me/2016/01/18/rxjava/" target="_blank" rel="external">RXJava</a><br><a href="http://gank.io/post/560e15be2dca930e00da1083" target="_blank" rel="external">给 Android 开发者的 RxJava 详解</a></p>

      
    </div>
    <footer>
      
        
        
        <div class="alignright">
          <a href="/2016/04/23/RXAndroid/#comment" class="comment-link">Comments</a>
        </div>
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




    <article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2016-04-12T06:06:15.000Z"><a href="/2016/04/12/Invalid-double崩溃分析/">2016-04-12</a></time>
        
  
    <h1 class="title"><a href="/2016/04/12/Invalid-double崩溃分析/">Invalid double崩溃分析</a></h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        
    </div>

        <p>第一次遇到</p>
<p>java.lang.NumberFormatException: Invalid double: “0,3”<br>这样包含逗号的浮点数异常，第一感觉就是服务器给的数据错误，但前段时间复现了这个异常，才发现是代码不规范导致了这样的异常： 崩溃的详细log如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">E/AndroidRuntime: FATAL EXCEPTION: mainProcess: com.frank.lollipopdemo, PID: </div><div class="line">10898java.lang.RuntimeException: Unable to start activity </div><div class="line">ComponentInfo&#123;com.frank.lollipopdemo/com.frank.lollipopdemo.MainActivity&#125;: </div><div class="line">java.lang.NumberFormatException: Invalid double: &quot;0,3&quot; at </div><div class="line">android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2325) at </div><div class="line">android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2387) at </div><div class="line">android.app.ActivityThread.access$800(ActivityThread.java:151) at </div><div class="line">android.app.ActivityThread$H.handleMessage(ActivityThread.java:1303) at </div><div class="line">android.os.Handler.dispatchMessage(Handler.java:102) at android.os.Looper.loop(Looper.java:135) at </div><div class="line">android.app.ActivityThread.main(ActivityThread.java:5254) at java.lang.reflect.Method.invoke(Native </div><div class="line">Method) at java.lang.reflect.Method.invoke(Method.java:372) at </div><div class="line">com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:903) at </div><div class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:698) Caused by: </div><div class="line">java.lang.NumberFormatException: Invalid double: &quot;0,3&quot; at </div><div class="line">java.lang.StringToReal.invalidReal(StringToReal.java:63) at </div><div class="line">java.lang.StringToReal.initialParse(StringToReal.java:164) at </div><div class="line">java.lang.StringToReal.parseDouble(StringToReal.java:282) at </div><div class="line">java.lang.Double.parseDouble(Double.java:301) at </div><div class="line">com.frank.lollipopdemo.MainActivity.onCreate(MainActivity.java:43) at </div><div class="line">android.app.Activity.performCreate(Activity.java:5990) at </div><div class="line">android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1106) at </div><div class="line">android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2278) at </div><div class="line">android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2387) at </div><div class="line">android.app.ActivityThread.access$800(ActivityThread.java:151) at </div><div class="line">android.app.ActivityThread$H.handleMessage(ActivityThread.java:1303) at </div><div class="line">android.os.Handler.dispatchMessage(Handler.java:102) at android.os.Looper.loop(Looper.java:135) at </div><div class="line">android.app.ActivityThread.main(ActivityThread.java:5254) at java.lang.reflect.Method.invoke(Native </div><div class="line">Method) at java.lang.reflect.Method.invoke(Method.java:372) at </div><div class="line">com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:903) at</div><div class="line">com.android.internal.os.ZygoteInit.main(ZygoteInit.java:698)</div></pre></td></tr></table></figure></p>
<p>而出错的代码是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">        super.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        tv_title = (TextView) findViewById(R.id.tv_title);</div><div class="line">        tv_content = (TextView) findViewById(R.id.tv_content);</div><div class="line">        String jsonVal = &quot;0.31415926&quot;;</div><div class="line">        String title = remain1Places(jsonVal);// -&gt; 0.3</div><div class="line">        tv_title.setText(title);</div><div class="line">        tv_content.setText(getPercent(Double.parseDouble(title)));// -&gt; ##.##%</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static String remain1Places(String string) &#123;</div><div class="line">        if (TextUtils.isEmpty(string)) &#123;</div><div class="line">            return &quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        return String.format(&quot;%.1f&quot;, Double.parseDouble(string));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public static String getPercent(double value) &#123;</div><div class="line">        NumberFormat numberFormat = NumberFormat.getPercentInstance();</div><div class="line">        numberFormat.setMinimumFractionDigits(1);</div><div class="line">        numberFormat.setMaximumFractionDigits(2);</div><div class="line">        return numberFormat.format(value);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>想把浮点数”0.31415926”保留一位小数，就使用了String.format()<br>方法完成，而且完全不顾编译器对我们的建议： <img src="http://upload-images.jianshu.io/upload_images/4398977-6b4a754e0cd9d8cb.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述">之后，我们想把保留了一位小数后的浮点数”0.3”转成百分比的形式”30.0%”，当然先转成double，然后利用NumberFormat<br>格式化成百分比。 看似没有问题，但是当我们把系统语言换成法语(France)之后，程序直接Crash，而且当我们只显示remain1Places()<br>后的title时，发现”0.31415926”变成了”0,3”，而不是”0.3”，这就直接导致了Double.parseDouble(“0,3”)抛出一个数据格式异常。 那为什么String.format()<br>会将小数点的”句点(.)“换成了”逗号(,)“呢？<br>摘自<a href="https://en.wikipedia.org/wiki/Decimal_mark" target="_blank" rel="external">维基百科</a>： A decimal mark is a symbol used to separate the integer part from the fractional part of a number written in decimal form. Different countries officially designate different symbols for the decimal mark. The choice of symbol for the decimal mark also affects the choice of symbol for the thousands separator used in digit grouping, so the latter is also treated in this article. <img src="http://upload-images.jianshu.io/upload_images/4398977-562e843356d6da5e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="这里写图片描述"></p>
<p>可以看到，有很多地区都是用<strong>逗号(,)</strong>作为<strong>小数点</strong>的，如19,90€表示19.9欧元；但计算机程序中的浮点数必须用<strong>句点(.)</strong>作为小数点，如double price = 19.90;<br>表示浮点数19.9。所以在使用double的包装类Double<br>的parseDouble(String)<br>或valueOf(String)<br>方法将字符串表示的double值转成double时，字符串所表示的double值必须是用<strong>句点(.)</strong>分隔的浮点数，也就是计算机的浮点数表示形式。<br>Double.valueOf(String)<br>方法仅仅调用了Double.parseDouble(String)<br>并返回Double<br>对象。 Double.parseDouble(String)<br>方法返回原语类型的double<br>变量。</p>
<p>因此，我们就可以断定这是一个本地化（Locale）的问题了。现在再来看一下编译器(lint)给我们String.format()<br>方法的建议：<br>Implicitly using the default locale is a common source of bugs: Use String.format(Locale, …) instead. 隐式地使用默认的区域设置是常见Bug源，请使用String.format(Locale, …)等方法替换它。</p>
<p>也就是说，String.format(String format, Object… args)<br>会调用format(Locale.getDefault(), format, args)<br>使用<strong>用户默认的区域设置</strong>返回格式化好且本地化好的字符串，因用户设置的不同而返回不同的字符串，进而出现Bug。如果你只是想格式化字符串而不是人为干预，应该用</p>
<p><code>String.format(Locale locale, String format, Object... args)</code><br>方法，Locale参数用Locale.US<br>就可以了。<br>因此，我们应该重视本地化问题：<br>将字符串所有字符转为大/小写的方法String.toLowerCase()<br>/String.toUpperCase()<br>并不一定能将字符真正的大/小写（如区域设置为土耳其时，i大写后还是i），因此应该指定要使用的区域设置String.toLowerCase(Locale locale)<br>/String.toUpperCase(Locale locale)<br>。<br>格式化字符串的方法String.format(String format, Object… args)<br>应该指定区域设置，以避免区域设置变化导致的Bug。<br><strong>千万不要将数字format()<br>成字符串后再将该字符串转回原语类型</strong>，因为format()<br>后的字符串可能不是合法的原语类型的数字了。即永远不要出现类似这样</p>
<p>Double.parseDouble(new DecimalFormat(“#.##”).format(doubleValue))<br>的代码。<br>建议使用NumberFormat<br>，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public static String remain1Places(String str) &#123;</div><div class="line">    NumberFormat numberFormat = NumberFormat.getInstance(Locale.getDefault());</div><div class="line">    numberFormat.setMinimumFractionDigits(1);</div><div class="line">    numberFormat.setMaximumFractionDigits(1);</div><div class="line">    return numberFormat.format(Double.parseDouble(str));</div><div class="line">&#125;</div><div class="line"></div><div class="line">public static String getPercent(String str) &#123;</div><div class="line">    NumberFormat numberFormat = NumberFormat.getPercentInstance(Locale.getDefault());</div><div class="line">    numberFormat.setMinimumFractionDigits(1);</div><div class="line">    numberFormat.setMaximumFractionDigits(2);</div><div class="line">    return numberFormat.format(Double.parseDouble(str));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        
        
        <div class="alignright">
          <a href="/2016/04/12/Invalid-double崩溃分析/#comment" class="comment-link">Comments</a>
        </div>
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




    <article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2016-04-03T06:21:44.000Z"><a href="/2016/04/03/Android动态添加权限/">2016-04-03</a></time>
        
  
    <h1 class="title"><a href="/2016/04/03/Android动态添加权限/">Android动态添加权限</a></h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        
    </div>

        <p>一、工具</p>
<p>权限适配工具 PermissionsDispatcher</p>
<p>使用注解</p>
<p>@RuntimePermissions 是必须的注册当前activity或fragment</p>
<p>@NeedsPermission 是必须要有的，在需要权限的方法上添加</p>
<p>@OnShowRationale 注释一个方法解释为什么需要这个(个)权限并提示用户判断是否允许</p>
<p>@OnPermissionDenied 当权限被拒绝时调用</p>
<p>@OnNeverAskAgain 当用户勾选了不再提示时调用</p>
<p>使用方法：</p>
<p>注意：同一组内的任何一个权限被授权了，其他权限也自动被授权。例如，一旦READ_CALENDAR被授权了，应用也有WRITE_CALENDAR权限了。</p>
<p>参考文档</p>
<p>Demo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div></pre></td><td class="code"><pre><div class="line">@RuntimePermissions</div><div class="line"></div><div class="line">public class MainActivity extends AppCompatActivity implements View.OnClickListener &#123;</div><div class="line"></div><div class="line">@Override</div><div class="line"></div><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line"></div><div class="line">super.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">findViewById(R.id.button_camera).setOnClickListener(this);</div><div class="line"></div><div class="line">findViewById(R.id.button_contacts).setOnClickListener(this);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"></div><div class="line">public void onClick(@NonNull View v) &#123;</div><div class="line"></div><div class="line">switch (v.getId()) &#123;</div><div class="line"></div><div class="line">case R.id.button_camera:</div><div class="line"></div><div class="line">// NOTE: delegate the permission handling to generated method</div><div class="line"></div><div class="line">MainActivityPermissionsDispatcher.showCameraWithCheck(this);</div><div class="line"></div><div class="line">break;</div><div class="line"></div><div class="line">case R.id.button_contacts:</div><div class="line"></div><div class="line">// NOTE: delegate the permission handling to generated method</div><div class="line"></div><div class="line">MainActivityPermissionsDispatcher.showContactsWithCheck(this);</div><div class="line"></div><div class="line">break;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line"></div><div class="line">public void onRequestPermissionsResult(int requestCode, @NonNull String[] permissions, @NonNull int[] grantResults) &#123;</div><div class="line"></div><div class="line">super.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line"></div><div class="line">// NOTE: delegate the permission handling to generated method</div><div class="line"></div><div class="line">MainActivityPermissionsDispatcher.onRequestPermissionsResult(this, requestCode, grantResults);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@NeedsPermission(Manifest.permission.CAMERA)</div><div class="line"></div><div class="line">void showCamera() &#123;</div><div class="line"></div><div class="line">// NOTE: Perform action that requires the permission. If this is run by PermissionsDispatcher, the permission will have been granted</div><div class="line"></div><div class="line">getSupportFragmentManager().beginTransaction()</div><div class="line"></div><div class="line">.replace(R.id.sample_content_fragment, CameraPreviewFragment.newInstance())</div><div class="line"></div><div class="line">.addToBackStack(&quot;camera&quot;)</div><div class="line"></div><div class="line">.commitAllowingStateLoss();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@NeedsPermission(&#123;Manifest.permission.READ_CONTACTS, Manifest.permission.WRITE_CONTACTS&#125;)</div><div class="line"></div><div class="line">void showContacts() &#123;</div><div class="line"></div><div class="line">// NOTE: Perform action that requires the permission.</div><div class="line"></div><div class="line">// If this is run by PermissionsDispatcher, the permission will have been granted</div><div class="line"></div><div class="line">getSupportFragmentManager().beginTransaction()</div><div class="line"></div><div class="line">.replace(R.id.sample_content_fragment, ContactsFragment.newInstance())</div><div class="line"></div><div class="line">.addToBackStack(&quot;contacts&quot;)</div><div class="line"></div><div class="line">.commitAllowingStateLoss();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@OnShowRationale(Manifest.permission.CAMERA)</div><div class="line"></div><div class="line">void showRationaleForCamera(PermissionRequest request) &#123;</div><div class="line"></div><div class="line">// NOTE: Show a rationale to explain why the permission is needed, e.g. with a dialog.</div><div class="line"></div><div class="line">// Call proceed() or cancel() on the provided PermissionRequest to continue or abort</div><div class="line"></div><div class="line">showRationaleDialog(R.string.permission_camera_rationale, request);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@OnShowRationale(&#123;Manifest.permission.READ_CONTACTS, Manifest.permission.WRITE_CONTACTS&#125;)</div><div class="line"></div><div class="line">void showRationaleForContact(PermissionRequest request) &#123;</div><div class="line"></div><div class="line">// NOTE: Show a rationale to explain why the permission is needed, e.g. with a dialog.</div><div class="line"></div><div class="line">// Call proceed() or cancel() on the provided PermissionRequest to continue or abort</div><div class="line"></div><div class="line">showRationaleDialog(R.string.permission_contacts_rationale, request);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@OnPermissionDenied(Manifest.permission.CAMERA)</div><div class="line"></div><div class="line">void onCameraDenied() &#123;</div><div class="line"></div><div class="line">// NOTE: Deal with a denied permission, e.g. by showing specific UI</div><div class="line"></div><div class="line">// or disabling certain functionality</div><div class="line"></div><div class="line">Toast.makeText(this, R.string.permission_camera_denied, Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">@OnNeverAskAgain(Manifest.permission.CAMERA)</div><div class="line"></div><div class="line">void onCameraNeverAskAgain() &#123;</div><div class="line"></div><div class="line">Toast.makeText(this, R.string.permission_camera_never_askagain, Toast.LENGTH_SHORT).show();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">public void onBackClick(View view) &#123;</div><div class="line"></div><div class="line">getSupportFragmentManager().popBackStack();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">private void showRationaleDialog(@StringRes int messageResId, final PermissionRequest request) &#123;</div><div class="line"></div><div class="line">new AlertDialog.Builder(this)</div><div class="line"></div><div class="line">.setPositiveButton(R.string.button_allow, new DialogInterface.OnClickListener() &#123;</div><div class="line"></div><div class="line">@Override</div><div class="line"></div><div class="line">public void onClick(@NonNull DialogInterface dialog, int which) &#123;</div><div class="line"></div><div class="line">request.proceed();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;)</div><div class="line"></div><div class="line">.setNegativeButton(R.string.button_deny, new DialogInterface.OnClickListener() &#123;</div><div class="line"></div><div class="line">@Override</div><div class="line"></div><div class="line">public void onClick(@NonNull DialogInterface dialog, int which) &#123;</div><div class="line"></div><div class="line">request.cancel();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;)</div><div class="line"></div><div class="line">.setCancelable(false)</div><div class="line"></div><div class="line">.setMessage(messageResId)</div><div class="line"></div><div class="line">.show();</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>权限适配工具 PermissionCompat</p>

      
    </div>
    <footer>
      
        
        
        <div class="alignright">
          <a href="/2016/04/03/Android动态添加权限/#comment" class="comment-link">Comments</a>
        </div>
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




    <article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2016-03-12T05:38:32.000Z"><a href="/2016/03/12/Java-SSL-Socket通讯实例二/">2016-03-12</a></time>
        
  
    <h1 class="title"><a href="/2016/03/12/Java-SSL-Socket通讯实例二/">Java SSL Socket通讯实例二</a></h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        
    </div>

        <p>对于SSL/TLS协议，如果要每个开发者都自己去实现显然会带来不必要的麻烦，正是为了解决这个问题<a href="http://www.2cto.com/kf/ware/Java/" target="_blank" rel="external">Java</a>为广大开发者提供了Java安全套接字扩展——JSSE，它包含了实现Internet安全通信的一系列包的集合，是SSL和TLS的纯Java实现，同时它是一个开放的标准，每个公司都可以自己实现JSSE，通过它可以透明地提供数据<a href="http://www.2cto.com/Article/jiami/" target="_blank" rel="external">加密</a>、服务器认证、信息完整性等功能，就像使用普通的套接字一样使用安全套接字，大大减轻了开发者的负担，使开发者可以很轻松将SSL协议整合到程序中，并且JSSE能将安全隐患降到了最低点。<br>在利用SSL/TLS进行安全通信时，客户端跟服务器端都必须要支持SSL/TLS协议，不然将无法进行通信。而且客户端和服务器端都可能要设置用于证实自己身份的安全证书，并且还要设置信任对方的哪些安全证书。<br>关于身份认证方面有个名词叫客户端模式，一般情况客户端要对服务器端的身份进行验证，但是无需向服务器证实自己的身份，这样不用向对方证实自己身份的通信端我们就说它处于客户模式，否则成它处于服务器模式。SSLSocket的setUseClientMode(Boolean mode)方法可以设置客户端模式或服务器模式。<br>下面看具体实现的过程<br>① 解决证书问题。<br>一般而言作为服务器端必须要有证书以证明这个服务器的身份，并且证书应该描述此服务器所有者的一些基本信息，例如公司名称、联系人名等。证书由所有人以密码形式签名，基本不可伪造，证书获取的途径有两个：一是从权威机构购买证书，权威机构担保它发出的证书的真实性，而且这个权威机构被大家所信任，进而你可以相信这个证书的有效性；另外一个是自己用JDK提供的工具keytool创建一个自我签名的证书，这种情况下一般是我只想要保证数据的安全性与完整性，避免数据在传送的过程中被窃听或篡改，此时身份的认证已不重要，重点已经在端与端传输的秘密性上，证书的作用只体现在加解密签名。<br>SSL协议通信涉及密钥储存的文件格式比较多，很容易搞混，例如xxx.cer、xxx.pfx、xxx.jks、xxx.keystore、xxx.truststore等格式文件。如图3-1-7-3，搞清楚他们有助于理解后面的程序，.cer格式文件俗称证书，但这个证书中没有私钥，只包含了公钥；.pfx格式文件也称为证书，它一般供<a href="http://www.2cto.com/os/liulanqi/" target="_blank" rel="external">浏览器</a>使用，而且它不仅包含了公钥，还包含了私钥，当然这个私钥是加密的，不输入密码是解不了密的；.jks格式文件表示java密钥存储器（java key store），它可以同时容纳N个公钥跟私钥，是一个密钥库；.keystore格式文件其实跟.jks基本是一样的，只是不同公司叫法不太一样，默认生成的证书存储库格式；.truststore格式文件表示信任证书存储库，它仅仅包含了通信对方的公钥，当然你可以直接把通信对方的jks作为信任库（就算如此你也只能知道通信对方的公钥，要知道密钥都是加密的，你无从获取，只要算法不被<a href="http://www.2cto.com/Article/jiami/" target="_blank" rel="external">破解</a>）。有些时候我们需要把pfx或cert转化为jks以便于用java进行ssl通信，例如一个银行只提供了pfx证书，而我们想用java进行ssl通信时就要将pfx转化为jks格式。<br><img src="http://upload-images.jianshu.io/upload_images/4398977-4282e92c21880f9a.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="\"><br>图3-1-7-3 密钥存储文件格式</p>
<p>按照理论上，我们一共需要准备四个文件，两个keystore文件和两个truststore文件，通信双方分别拥有一个keystore和一个truststore，keystore用于存放自己的密钥和公钥，truststore用于存放所有需要信任方的公钥。这里为了方便直接使用jks即keystore替代truststore（免去证书导来导去），因为对方的keystore包含了自己需要的信任公钥。<br>下面使用jdk自带的工具分别生成服务器端证书，通过如下命令并输入姓名、组织单位名称、组织名称、城市、省份、国家信息即可生成证书密码为tomcat的证书，此证书存放在密码也为tomcat的tomcat.jks证书存储库中。如果你继续创建证书将继续往tomcat.jks证书存储库中添加证书。如果你仅仅输入keytool -genkey -alias tomcat -keyalg RSA -keypass tomcat -storepass tomcat，不指定证书存储库的文件名及路径，则工具会在用户的home directory目录下生产一个“.keystore”文件作为证书存储库。<br><img src="http://upload-images.jianshu.io/upload_images/4398977-b9350297f1636989.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="\"><br>类似的，客户端证书也用此方式进行生成。如下<br><img src="http://upload-images.jianshu.io/upload_images/4398977-d60598093e5c7d93.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="\"><br>② 服务端TomcatSSLServer.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">public class TomcatSSLServer &#123;</div><div class="line"> private static final String SSL_TYPE = &quot;SSL&quot;;</div><div class="line"> private static final String KS_TYPE = &quot;JKS&quot;;</div><div class="line"> private static final String X509 = &quot;SunX509&quot;;</div><div class="line"> private final static int PORT = 443;</div><div class="line"> private static TomcatSSLServer sslServer;</div><div class="line"> private SSLServerSocket svrSocket;</div><div class="line">   </div><div class="line"> public static TomcatSSLServer getInstance() throws Exception &#123;</div><div class="line">   if (sslServer == null) &#123;</div><div class="line">    sslServer = new TomcatSSLServer();</div><div class="line">   &#125;</div><div class="line">   return sslServer;</div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> private TomcatSSLServer() throws Exception&#123;</div><div class="line">  SSLContext sslContext = createSSLContext();</div><div class="line">  SSLServerSocketFactory serverFactory = sslContext.getServerSocketFactory();</div><div class="line">  svrSocket =(SSLServerSocket) serverFactory.createServerSocket(PORT);</div><div class="line">  svrSocket.setNeedClientAuth(true); </div><div class="line">  String[] supported = svrSocket.getEnabledCipherSuites();</div><div class="line">  svrSocket.setEnabledCipherSuites(supported);</div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> private SSLContext createSSLContext() throws Exception&#123;</div><div class="line">  KeyManagerFactory kmf = KeyManagerFactory.getInstance(X509);</div><div class="line">  TrustManagerFactory tmf = TrustManagerFactory.getInstance(X509);</div><div class="line">  String serverKeyStoreFile = &quot;c:\\tomcat.jks&quot;; </div><div class="line">  String svrPassphrase = &quot;tomcat&quot;;               </div><div class="line">  char[] svrPassword = svrPassphrase.toCharArray();</div><div class="line">  KeyStore serverKeyStore = KeyStore.getInstance(KS_TYPE);</div><div class="line">  serverKeyStore.load(new FileInputStream(serverKeyStoreFile), svrPassword);</div><div class="line">  kmf.init(serverKeyStore, svrPassword);</div><div class="line">  String clientKeyStoreFile = &quot;c:\\client.jks&quot;; </div><div class="line">  String cntPassphrase = &quot;client&quot;;              </div><div class="line">  char[] cntPassword = cntPassphrase.toCharArray();</div><div class="line">  KeyStore clientKeyStore = KeyStore.getInstance(KS_TYPE);</div><div class="line">  clientKeyStore.load(new FileInputStream(clientKeyStoreFile),cntPassword);</div><div class="line">  tmf.init(clientKeyStore);</div><div class="line">  SSLContext sslContext  = SSLContext.getInstance(SSL_TYPE);</div><div class="line">  sslContext.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);</div><div class="line">  return sslContext;</div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> public void startService() &#123;</div><div class="line">  SSLSocket cntSocket = null;</div><div class="line">  BufferedReader ioReader = null;</div><div class="line">  PrintWriter ioWriter = null;</div><div class="line">  String tmpMsg = null;</div><div class="line">  while( true ) &#123;</div><div class="line">   try &#123;</div><div class="line">    cntSocket =(SSLSocket) svrSocket.accept();</div><div class="line">    ioReader = new BufferedReader(new InputStreamReader(cntSocket.getInputStream()));</div><div class="line">    ioWriter = new PrintWriter(cntSocket.getOutputStream());</div><div class="line">    while ( (tmpMsg = ioReader.readLine()) != null) &#123;</div><div class="line">     System.out.println(&quot;客户端通过SSL协议发送信息:&quot;+tmpMsg);</div><div class="line">     tmpMsg=&quot;欢迎通过SSL协议连接&quot;;</div><div class="line">     ioWriter.println(tmpMsg);</div><div class="line">     ioWriter.flush();</div><div class="line">    &#125;</div><div class="line">   &#125; catch(IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">   &#125; finally &#123;</div><div class="line">    try &#123;</div><div class="line">     if(cntSocket != null) cntSocket.close();</div><div class="line">    &#125; catch(Exception ex) &#123;ex.printStackTrace();&#125;</div><div class="line">   &#125;</div><div class="line">  &#125;</div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> public static void main(String[] args) throws Exception &#123;</div><div class="line">  TomcatSSLServer.getInstance().startService();</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基本顺序是先得到一个SSLContext实例，再对SSLContext实例进行初始化，密钥管理器及信任管理器作为参数传入，证书管理器及信任管理器按照指定的密钥存储器路径和密码进行加载。接着设置支持的加密套件，最后让SSLServerSocket开始监听客户端发送过来的消息。</p>
<p>③ 客户端TomcatSSLClient.java<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">public class TomcatSSLClient &#123;</div><div class="line"> private static final String SSL_TYPE = &quot;SSL&quot;;</div><div class="line"> private static final String X509 = &quot;SunX509&quot;;</div><div class="line"> private static final String KS_TYPE = &quot;JKS&quot;;</div><div class="line"> private SSLSocket sslSocket;</div><div class="line">   </div><div class="line"> public TomcatSSLClient(String targetHost,int port) throws Exception &#123;</div><div class="line">  SSLContext sslContext = createSSLContext(); </div><div class="line">  SSLSocketFactory sslcntFactory =(SSLSocketFactory) sslContext.getSocketFactory();</div><div class="line">  sslSocket = (SSLSocket) sslcntFactory.createSocket(targetHost, port);</div><div class="line">  String[] supported = sslSocket.getSupportedCipherSuites();</div><div class="line">  sslSocket.setEnabledCipherSuites(supported); </div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> private SSLContext createSSLContext() throws Exception&#123;</div><div class="line">  KeyManagerFactory kmf = KeyManagerFactory.getInstance(X509);</div><div class="line">  TrustManagerFactory tmf = TrustManagerFactory.getInstance(X509);</div><div class="line">  String clientKeyStoreFile = &quot;c:\\client.jks&quot;;</div><div class="line">  String cntPassphrase = &quot;client&quot;;</div><div class="line">  char[] cntPassword = cntPassphrase.toCharArray();</div><div class="line">  KeyStore clientKeyStore = KeyStore.getInstance(KS_TYPE);</div><div class="line">  clientKeyStore.load(new FileInputStream(clientKeyStoreFile),cntPassword);</div><div class="line">  String serverKeyStoreFile = &quot;c:\\tomcat.jks&quot;;</div><div class="line">  String svrPassphrase = &quot;tomcat&quot;;</div><div class="line">  char[] svrPassword = svrPassphrase.toCharArray();</div><div class="line">  KeyStore serverKeyStore = KeyStore.getInstance(KS_TYPE);</div><div class="line">  serverKeyStore.load(new FileInputStream(serverKeyStoreFile), svrPassword);</div><div class="line">  kmf.init(clientKeyStore, cntPassword);</div><div class="line">  tmf.init(serverKeyStore);</div><div class="line">  SSLContext sslContext  = SSLContext.getInstance(SSL_TYPE);</div><div class="line">  sslContext.init(kmf.getKeyManagers(), tmf.getTrustManagers(), null);</div><div class="line">  return sslContext;</div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> public String sayToSvr(String sayMsg) throws IOException&#123;</div><div class="line">  BufferedReader ioReader = new BufferedReader(new InputStreamReader(</div><div class="line">    sslSocket.getInputStream()));</div><div class="line">  PrintWriter ioWriter = new PrintWriter(sslSocket.getOutputStream());</div><div class="line">  ioWriter.println(sayMsg);</div><div class="line">  ioWriter.flush();</div><div class="line">  return ioReader.readLine();</div><div class="line"> &#125;</div><div class="line">   </div><div class="line"> public static void main(String[] args) throws Exception &#123;</div><div class="line">  TomcatSSLClient sslSocket = new TomcatSSLClient(&quot;127.0.0.1&quot;,443);</div><div class="line">  BufferedReader ioReader = new BufferedReader(new InputStreamReader(System.in));</div><div class="line">  String sayMsg = &quot;&quot;;</div><div class="line">  String svrRespMsg= &quot;&quot;;</div><div class="line">  while( (sayMsg = ioReader.readLine())!= null ) &#123;</div><div class="line">   svrRespMsg = sslSocket.sayToSvr(sayMsg);</div><div class="line">   if(svrRespMsg != null &amp;&amp; !svrRespMsg.trim().equals(&quot;&quot;)) &#123;</div><div class="line">    System.out.println(&quot;服务器通过SSL协议响应:&quot;+svrRespMsg);</div><div class="line">   &#125;</div><div class="line">  &#125;</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>客户端的前面操作基本跟服务器端的一样，先创建一个SSLContext实例，再用密钥管理器及信任管理器对SSLContext进行初始化，当然这里密钥存储的路径是指向客户端的client.jks。接着设置加密套件，最后使用SSLSocket进行通信。</p>
<p>注意服务器端有行代码svrSocket.setNeedClientAuth(true);它是非常重要的一个设置方法，用于设置是否验证客户端的身份。假如我们把它注释掉或设置为false，此时客户端将不再需要自己的密钥管理器，即服务器不需要通过client.jks对客户端的身份进行验证，把密钥管理器直接设置为null也可以跟服务器端进行通信。</p>
<p>最后谈谈信任管理器，它的职责是决定是否信任远端的证书，那么它凭借什么去判断呢？如果不显式设置信任存储器的文件路径，将遵循如下规则：①如果<a href="http://www.2cto.com/os/" target="_blank" rel="external">系统</a>属性javax.net.ssl.truststore指定了truststore文件，那么信任管理器将去jre路径下的lib/security目录寻找这个文件作为信任存储器；②如果没设置①中的系统属性，则去寻找一个%java_home%/lib/security/jssecacerts文件作为信任存储器；③如果jssecacerts不存在而cacerts存在，则cacerts作为信任存储器。<br>至此，一个利用JSSE实现BIO模式的SSL协议通信的例子已完成。</p>

      
    </div>
    <footer>
      
        
        
        <div class="alignright">
          <a href="/2016/03/12/Java-SSL-Socket通讯实例二/#comment" class="comment-link">Comments</a>
        </div>
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>




    <article class="post">
  
  <div class="post-content">
    <header>
        <div class="icon"></div>
        
        <time datetime="2016-03-11T08:09:54.000Z"><a href="/2016/03/11/SwipeRefreshLayout和ListView的EmptyView共存冲突的问题/">2016-03-11</a></time>
        
  
    <h1 class="title"><a href="/2016/03/11/SwipeRefreshLayout和ListView的EmptyView共存冲突的问题/">SwipeRefreshLayout和ListView的EmptyView共存冲突的问题</a></h1>
  

    </header>

    <div class="entry">
      
        
    <div id="toc">
        
    </div>

        <p>SwipeRefreshLayout是android官方的下拉刷新控件；<br>它内部有且只能有一个子控件；<br>当一个ListView嵌入到它内部时，就不能为ListView带一个EmptyView了；<br>于是很自然的想到将ListView和EmptyView纳入到一个父控件中；<br>典型的像下面这样的布局：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;android.support.v4.widget.SwipeRefreshLayout</div><div class="line">        android:id=&quot;@+id/swipeRefreshLayout&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot; &gt;</div><div class="line"></div><div class="line">        &lt;FrameLayout</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot; &gt;</div><div class="line"></div><div class="line">            &lt;ListView</div><div class="line">                android:id=&quot;@+id/listView&quot;</div><div class="line">                android:layout_width=&quot;match_parent&quot;</div><div class="line">                android:layout_height=&quot;match_parent&quot;</div><div class="line">                android:cacheColorHint=&quot;@android:color/transparent&quot;</div><div class="line">                android:divider=&quot;@color/text_color_c4&quot;</div><div class="line">                android:dividerHeight=&quot;@dimen/line_width&quot;</div><div class="line">                android:footerDividersEnabled=&quot;true&quot; /&gt;</div><div class="line"></div><div class="line">            &lt;include</div><div class="line">                android:id=&quot;@+id/emptyView&quot;</div><div class="line">                layout=&quot;@layout/empty_view_for_tang_friend_0&quot; /&gt;</div><div class="line">        &lt;/FrameLayout&gt;</div><div class="line">    &lt;/android.support.v4.widget.SwipeRefreshLayout&gt;</div></pre></td></tr></table></figure></p>
<p>这样就可以实现ListView和EmptyView都下拉刷新了；<br>但是问题来了，当ListView的数据超过一屏的时候，再往上滑，滑不上去了；<br>这就是SwipeRefreshLayout和ListView的EmptyView共存冲突的问题（如果SwipeRefreshLayout中仅有一个ListView的话没问题，但现在多了一个EmptyView）； </p>
<p>解决办法有是有，虽然不那么优雅：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">swipeRefreshLayout = (android.support.v4.widget.SwipeRefreshLayout) v.findViewById(R.id.swipeRefreshLayout);</div><div class="line">                swipeRefreshLayout.setColorSchemeResources(R.color.text_color_c6, R.color.yellow, R.color.grey, R.color.red);</div><div class="line">                swipeRefreshLayout.setOnRefreshListener(new SwipeRefreshLayout.OnRefreshListener()</div><div class="line">                &#123;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public void onRefresh()</div><div class="line">                    &#123;</div><div class="line">                        // TODO Auto-generated method stub</div><div class="line">                        //dosomething</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">listView = (ListView) v.findViewById(R.id.listView);</div><div class="line">                listView.setOnScrollListener(new AbsListView.OnScrollListener()</div><div class="line">                &#123;</div><div class="line">                    @Override</div><div class="line">                    public void onScrollStateChanged(AbsListView absListView, int i)</div><div class="line">                    &#123;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    @Override</div><div class="line">                    public void onScroll(AbsListView absListView, int firstVisibleItem, int visibleItemCount, int totalItemCount)</div><div class="line">                    &#123;</div><div class="line">                        if (firstVisibleItem == 0)</div><div class="line">                            swipeRefreshLayout.setEnabled(true);</div><div class="line">                        else</div><div class="line">                            swipeRefreshLayout.setEnabled(false);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div></pre></td></tr></table></figure></p>
<p>在ListView滑动的时候做一个判断，看看是不是滑动到顶部了，到顶部了就swipeRefreshLayout.setEnabled(true);让SwipeRefreshLayout可以接受动作，这样就ok了。 </p>
<p>上面的解决方案比较简单，但是有个小问题，就是当listView滑动到第一个Item（让第一个Item显示一半）的时候，再上滑就上不去了，始终显示半个Item。<br>为了解决这个问题，只能使用笨办法了：将ListView和EmptyView分离，让他们两个分别被两个SwipeRefreshLayout包裹，如下面的布局：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</div><div class="line">    android:layout_width=&quot;match_parent&quot;</div><div class="line">    android:layout_height=&quot;match_parent&quot; &gt;</div><div class="line"></div><div class="line">    &lt;android.support.v4.widget.SwipeRefreshLayout</div><div class="line">        android:id=&quot;@+id/swipeRefreshLayout&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot; &gt;</div><div class="line"></div><div class="line">        &lt;cn.tangdada.tangbang.widget.LoadMoreListView</div><div class="line">            android:id=&quot;@+id/listView&quot;</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot;</div><div class="line">            android:cacheColorHint=&quot;@android:color/transparent&quot;</div><div class="line">            android:divider=&quot;@color/text_color_c4&quot;</div><div class="line">            android:dividerHeight=&quot;@dimen/line_width&quot;</div><div class="line">            android:footerDividersEnabled=&quot;false&quot; /&gt;</div><div class="line">    &lt;/android.support.v4.widget.SwipeRefreshLayout&gt;</div><div class="line"></div><div class="line">    &lt;android.support.v4.widget.SwipeRefreshLayout</div><div class="line">        android:id=&quot;@+id/swipeRefreshLayoutEmptyView&quot;</div><div class="line">        android:layout_width=&quot;match_parent&quot;</div><div class="line">        android:layout_height=&quot;match_parent&quot;</div><div class="line">        android:visibility=&quot;gone&quot; &gt;</div><div class="line"></div><div class="line">        &lt;TextView</div><div class="line">            android:layout_width=&quot;match_parent&quot;</div><div class="line">            android:layout_height=&quot;match_parent&quot;</div><div class="line">            android:gravity=&quot;center&quot;</div><div class="line">            android:paddingLeft=&quot;32dp&quot;</div><div class="line">            android:paddingRight=&quot;32dp&quot;</div><div class="line">            android:text=&quot;@string/empty&quot;</div><div class="line">            android:textColor=&quot;@color/text_color_c3&quot;</div><div class="line">            android:textSize=&quot;@dimen/font_big&quot; /&gt;</div><div class="line">    &lt;/android.support.v4.widget.SwipeRefreshLayout&gt;</div><div class="line"></div><div class="line">&lt;/FrameLayout&gt;</div></pre></td></tr></table></figure></p>
<p>然后需要在代码中控制显示EmptyView的时机，比如我这里的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">private void updateViews(Object obj)</div><div class="line">    &#123;</div><div class="line">        ArrayList&lt;User&gt; list = (ArrayList&lt;User&gt;) obj;</div><div class="line">        if (list.size() == 0)</div><div class="line">        &#123;</div><div class="line">            //listView.removeLoadMoreListener();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        users.addAll(list);</div><div class="line"></div><div class="line">        if (users.size() == 0)</div><div class="line">        &#123;</div><div class="line">            swipeRefreshLayout.setVisibility(View.GONE);</div><div class="line">            swipeRefreshLayout.setRefreshing(false);</div><div class="line">            swipeRefreshLayoutEmptyView.setVisibility(View.VISIBLE);</div><div class="line">            swipeRefreshLayoutEmptyView.setRefreshing(false);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">            //listView.onLoadMoreComplete();</div><div class="line">            swipeRefreshLayout.setVisibility(View.VISIBLE);</div><div class="line">            swipeRefreshLayout.setRefreshing(false);</div><div class="line">            swipeRefreshLayoutEmptyView.setVisibility(View.GONE);</div><div class="line">            swipeRefreshLayoutEmptyView.setRefreshing(false);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        notifyDataSetChanged();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    <footer>
      
        
        
        <div class="alignright">
          <a href="/2016/03/11/SwipeRefreshLayout和ListView的EmptyView共存冲突的问题/#comment" class="comment-link">Comments</a>
        </div>
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



 
<nav id="pagination">
  
    <a href="/page/7/" class="alignleft prev">上一页</a>
  
  
    <a href="/page/9/" class="alignright next">下一页</a>
  
  <div class="clearfix"></div>
</nav>
</div></div>
      <aside id="sidebar" class="alignright">
  
<div class="widget tag">
  <h3 class="title" id="categories">分类</h3>
     <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">17</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Cordova/">Cordova</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MQTT/">MQTT</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenCV/">OpenCV</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/SSL/">SSL</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/kotlin/">kotlin</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓直播开发/">安卓直播开发</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">7</span></li></ul> 
</div>
 


  <div class="widget tag">
  <h3 class="title">微信公众账号</h3>
    <ul class="entry">
      <img src="/img/default/wx.png" alt="欢迎关注，该账号供个人学习使用，主要分享安卓开发技术以及前沿技术。" style= "width: 100%">
    </ul>
</div>

  <div class="widget tag">
  <h3 class="title">日历云</h3>
  <div id="calendar"></div>
</div>


  
<div class="widget">
  <h3 class="title">最新评论</h3>
  	<!-- 多说最新评论 start -->
	<div class="ds-recent-comments ds-recent-user" data-num-items="5" data-show-avatars="1" data-show-time="1" data-show-title="1" data-show-admin="1" data-excerpt-length="70"></div>
	<!-- 多说最新评论 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"samychen"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
		</script>
	<!-- 多说公共JS代码 end -->
</div>



  


  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/Cordova/" style="font-size: 15px;">Cordova</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/MQTT/" style="font-size: 11.67px;">MQTT</a> <a href="/tags/SSL/" style="font-size: 10px;">SSL</a> <a href="/tags/SSL，Https/" style="font-size: 13.33px;">SSL，Https</a> <a href="/tags/SSL，Https，安卓/" style="font-size: 10px;">SSL，Https，安卓</a> <a href="/tags/单例模式/" style="font-size: 11.67px;">单例模式</a> <a href="/tags/安卓/" style="font-size: 16.67px;">安卓</a> <a href="/tags/安卓，Java/" style="font-size: 18.33px;">安卓，Java</a> <a href="/tags/工厂模式/" style="font-size: 10px;">工厂模式</a> <a href="/tags/生产者消费者模式/" style="font-size: 11.67px;">生产者消费者模式</a> <a href="/tags/网络协议/" style="font-size: 10px;">网络协议</a> <a href="/tags/装饰者模式/" style="font-size: 11.67px;">装饰者模式</a>
  </div>
</div>


  
  <div class="widget tag">
    <h3 class="title">归档</h3>
	<ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/">公元 2018 年</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/">公元 2017 年</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/">公元 2016 年</a><span class="archive-list-count">21</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/">公元 2015 年</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/">公元 2014 年</a><span class="archive-list-count">10</span></li></ul>
  </div>

</aside>
      <div class="clearfix"></div>
    </div>
  
  <footer id="footer"><div class="footer-content inner">
  <div class="alignleft">
  
    &copy; 2018 SamyChen
    
  </div>
  <div class="alignright">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme
    <a href="https://github.com/pengloo53/Hexo-theme-light_cn">light_cn</a>
  </div>
  
  <div class="visit">
    本站总访问量<span id="busuanzi_value_site_pv"></span>次
  </div>
  
  <div class="clearfix"></div>
</div></footer>
  <script src="http://libs.baidu.com/jquery/2.1.1/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>

<!-- calendar widget -->

  <script src="/js/calendar.js"></script>
  <script src="/js/languages.js"></script>
  <script type="text/javascript">
    $(function() {
    
      $('#calendar').aCalendar('zh-CN',{single:undefined, root:'calendar'});
    
    });
  </script>


<!-- 『不蒜子』计数服务 -->
<script async src="http://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- wumii关联推荐 -->
<script type="text/javascript" src="http://widget.wumii.cn/ext/relatedItemsWidget"></script>

<!-- 百度推荐 -->

	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?9acf0cedd48dc53be256ede5a98c2aaa";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>


<!-- 返回顶部 -->
<div id="toTop">
	<a href="#">▲</a>
	<a href="#footer">▼</a>
</div>

<!-- 站内搜索-Swiftype -->
<!-- <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','sC-iNFrvTTNtiXEVNwo1','2.0.0');
</script> -->

<!-- fancybox -->

<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
</html>
